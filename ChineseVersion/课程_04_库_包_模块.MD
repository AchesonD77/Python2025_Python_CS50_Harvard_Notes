# 讲义 4 — 库、随机数、命令行、包、API

## 目录
- [库（Libraries）](#库libraries)
- [随机（Random）](#随机random)
- [统计（Statistics）](#统计statistics)
- [命令行参数](#命令行参数)
- [切片（Slice）](#切片slice)
- [第三方包（Packages）](#第三方包packages)
- [API](#api)
- [自制库（Making Your Own Libraries）](#自制库making-your-own-libraries)
- [小结](#小结)

---

## 库（Libraries）

- 在 Python 中，**库/模块**是你或他人编写、可被复用的代码单元。
- 通过 *module* 可以把函数/能力分享给他人；
- 也可把旧项目中的通用代码抽成 **库**。

---

## 随机（Random）
- Random 是 Python 附带的一个库，您可以将其导入到您自己的项目中。
- 内置 **`random`** 库可生成随机选择与随机数。
- 你可以在程序中使用 import 这个词。

**`random.choice(seq)`** — 从序列中随机选一个：
- 在 random 模块中，有一个名为 random.choice(seq) 的内置函数。random 是您要导入的模块。在该模块中，有一个 choice 函数。该函数的参数是一个列表形式的 seq 或序列。

```python
import random

coin = random.choice(["heads", "tails"])
print(coin)
```
- 我们可以改进代码。使用 from 来实现我们非常具体地指定要导入的内容。
- 之前，我们的 import 代码行导入了 random 函数的全部内容。但是，如果我们只想加载模块的一小部分怎么办？请按如下方式修改代码：
- 也可只导入需要的名字，提升可读性：

```python
from random import choice

coin = choice(["heads", "tails"])
print(coin)
```
- 注意，我们现在可以只导入 random 的 choice 函数。从现在开始，我们不再需要编写 random.choice 代码。我们现在只需单独编写 choice 代码即可。choice 会被显式加载到我们的程序中。 choice 节省了系统资源，并有可能提高代码的运行速度！

**`random.randint(a, b)`** — 生成 **闭区间** `[a, b]` 内的整数：

```python
from random import randint

number = randint(1, 10)
print(number)
```
- 请注意，我们的代码将随机生成一个介于 1 到 10 之间的数字。

**`random.shuffle(list)`** — 原地打乱列表（返回 `None`）：

```python
import random

cards = ["jack", "queen", "king"]
random.shuffle(cards)
for card in cards:
    print(card)
```
- 注意， random.shuffle 会将卡片原地打乱。与其他函数不同，它不会返回任何值。相反，它会获取 cards 列表，并在列表中对卡片进行打乱。运行几次代码，看看代码是否正常运行。

<mark>要点：</mark>熟练使用 **`choice`**、**`randint`**、**`shuffle`** 三件套。

---

## 统计（Statistics）

- Python 自带 **`statistics`** 模块；常用 **`mean`**：

```python
import statistics

print(statistics.mean([100, 90]))
```
- 注意，我们导入了一个名为 statistics 的库。mean 接受一个值列表。这将打印这些值的平均值。在终端窗口中，输入 python average.py 。
  

- 文档：Python `statistics`。（https://docs.python.org/3/library/statistics.html）

---

## 命令行参数

- 到目前为止，我们已经在创建的程序中提供了所有值。如果我们想要从命令行获取输入怎么办？例如，我们不想在终端中输入 python average.py ，而是想输入 python average.py 100 90 并获取 100 到 90 之间的平均值，该怎么办？

- 通过 **`sys`** 模块读取 **`sys.argv`** 列表：
- argv 是 sys 模块中的一个列表，用于记录用户在命令行上输入的内容。

```python
import sys

print("hello, my name is", sys.argv[1])
```
- 注意， sys.argv[1] 是存储 David 位置。这是为什么呢？在之前的课程中，你可能还记得列表是从第 0 个元素开始的。你认为 sys.argv[0] 中当前存储的是什么？如果你猜是 name.py ，那你就猜对了！
- `sys.argv[0]` 是脚本名，**第一个真实参数是 `sys.argv[1]`**。
  

- 我们的程序目前存在一个小问题。如果用户没有在命令行中输入名称会怎样？自己试试。在终端窗口中输入 python name.py 。解释器会显示一个错误 list index out of range 。原因是 sys.argv[1] 中没有任何内容，因为用户没有输入任何内容！以下是一些保护程序免受此类错误影响的方法：
- 用 **异常** 兜底缺参：

```python
import sys

try:
    print("hello, my name is", sys.argv[1])
except IndexError:
    print("Too few arguments")
```

- 更健壮：**长度判断** + **提前退出** `sys.exit`：
- 将错误检查与其余代码分开是非常好的：
```python
import sys

if len(sys.argv) < 2:
    sys.exit("Too few arguments")
elif len(sys.argv) > 2:
    sys.exit("Too many arguments")

print("hello, my name is", sys.argv[1])
```

- `sys.exit` 立即结束程序；只有输入正确时才会执行最后一行。
- 注意，我们使用了 sys 的内置函数 exit ，当用户引入错误时，该函数可以退出程序。现在我们可以放心，程序永远不会执行到最后一行代码并触发错误。因此， sys.argv 提供了一种用户从命令行引入信息的方式 sys.exit 提供了一种在出现错误时退出程序的方法。
---

## 切片（Slice）

- 用切片跳过脚本名：**`sys.argv[1:]`**。
- slice 是一个命令，它允许我们获取一个 list ，并告诉解释器我们希望解释器在哪里考虑 list 的开头和结尾。例如，修改 list 如下：

```python
import sys

if len(sys.argv) < 2:
    sys.exit("Too few arguments")

for arg in sys.argv[1:]:
    print("hello, my name is", arg)
```
- 注意，我们不是从 0 开始列表，而是使用方括号来告诉解释器从 1 开始，并使用 1: 参数转到末尾。运行这段代码，你会发现我们可以使用相对简单的语法来改进代码。


- <mark>提示：</mark>切片 `list[start:end]` 左闭右开；省略 `end` 表示直到末尾。

---

## 第三方包（Packages）
- Python 如此受欢迎的原因之一是它拥有众多强大的第三方库，可以为其增添功能。我们称这些以文件夹形式实现的第三方库为“包”。
- 第三方包托管在 **PyPI**，用 **`pip`** 安装。
- 例：**`cowsay`**（会“说话”的小牛）：

```bash
pip install cowsay
```

```python
import cowsay, sys

if len(sys.argv) == 2:
    cowsay.cow("hello, " + sys.argv[1])
```

- 其他变体：

```python
import cowsay, sys

if len(sys.argv) == 2:
    cowsay.trex("hello, " + sys.argv[1])
```

- 更多包见 <mark>PyPI</mark>。（https://pypi.org/）

---

## API

- **API** 让程序与外部服务通信。API 或“应用程序接口”允许您连接到其他人的代码。
- **`requests`** 像浏览器一样请求网络数据。requests 是一个允许您的程序像 Web 浏览器一样运行的包。
  先安装：

```bash
pip install requests
```

- 访问 Apple iTunes Search API：

```python
import requests, sys

if len(sys.argv) != 2:
    sys.exit()

response = requests.get(
    "https://itunes.apple.com/search?entity=song&limit=1&term=" + sys.argv[1]
)
print(response.json())
```
- 事实证明，Apple iTunes 拥有自己的 API，您可以在程序中访问。在您的互联网浏览器中，您可以访问 https://itunes.apple.com/search?entity=song&limit=1&term=weezer ，然后会下载一个文本文件。David 通过阅读 Apple 的 API 文档构建了这个 URL。请注意，此查询用于查找与 term weezer 相关的 song ， limit 为一个结果。查看下载的这个文本文件，您可能会发现其格式与我们之前用 Python 编写的格式类似。


- 下载的文本文件中的格式称为 JSON，这是一种基于文本的格式，用于在应用程序之间交换基于文本的数据。实际上，Apple 提供了一个 JSON 文件，我们可以在自己的 Python 程序中对其进行解释。
- 用 **`json`** 模块更友好地打印：
- Python 会将 JSON 响应转换为字典。
- 事实证明，Python 有一个内置的 JSON 库，可以帮助我们解释接收到的数据。修改代码如下：

```python
import json, requests, sys

if len(sys.argv) != 2:
    sys.exit()

response = requests.get(
    "https://itunes.apple.com/search?entity=song&limit=1&term=" + sys.argv[1]
)
print(json.dumps(response.json(), indent=2))
```
- 请注意， json.dumps 实现方式是利用 indent 来提高输出的可读性。运行 python itunes.py weezer ，您将看到相同的 JSON 文件。但是，这次它的可读性更强。现在请注意，您将在输出中看到一个名为 results 的字典。该 results 中包含许多键。查看输出中的 trackName 值。您在结果中看到的曲目名称是什么？
  

- 我们怎么才能只输出该曲目的名称呢？
- 提取多条结果的 **歌名**（`limit=50`）：

```python
import json, requests, sys

if len(sys.argv) != 2:
    sys.exit()

response = requests.get(
    "https://itunes.apple.com/search?entity=song&limit=50&term=" + sys.argv[1]
)
o = response.json()
for result in o["results"]:
    print(result["trackName"])
```
- 注意，我们获取了 response.json() 的结果并将其存储在 o 中（小写字母）。然后，我们遍历 o 中的 results 并打印每个 trackName 。还要注意，我们将结果限制增加到了 50 。运行程序，查看结果。


- 文档：`requests` https://docs.python-requests.org/ 指南；Python `json` https://docs.python.org/3/library/json.html 。

---

## 自制库（Making Your Own Libraries）

- 你可以把可复用逻辑抽成**自定义库**。

`sayings.py`：

```python
def hello(name):
    print(f"hello, {name}")

def goodbye(name):
    print(f"goodbye, {name}")
```

`say.py`：

```python
import sys
from sayings import goodbye

if len(sys.argv) == 2:
    goodbye(sys.argv[1])
```

<mark>核心思想：</mark>把可复用函数**模块化**，在需要处 `import`。

---

## 小结

库扩展了 Python 的功能。有些库是 Python 默认自带的，只需导入即可。其他库则是第三方软件包，需要使用 pip 安装。您可以创建自己的软件包，供自己或他人使用！在本讲座中，您学习了……
你学习了：

- **库（Libraries）**
- **随机**（`choice`、`randint`、`shuffle`）
- **统计**（`mean`）
- **命令行参数**（`sys.argv`、`sys.exit`）
- **切片**（`argv[1:]`）
- **第三方包**（PyPI、`pip`、`cowsay`）
- **API**（`requests`、`json`、iTunes Search）
- **自制库**
